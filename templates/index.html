<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMatch - Paragliding Forecast Matcher</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 600;
            color: #495057;
        }
        
        select {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            background: white;
            transition: border-color 0.3s;
        }
        
        select:hover {
            border-color: #667eea;
        }
        
        .forecast-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .forecast-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .forecast-btn:active {
            transform: translateY(0);
        }
        
        .match-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .match-btn {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .match-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }
        
        .match-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .match-btn .score {
            font-size: 0.85em;
            opacity: 0.8;
            display: block;
        }
        
        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .skewt-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .skewt-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        .loading {
            padding: 60px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .scatter-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .scatter-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #212529;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .info-panel {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .info-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
            font-weight: 500;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .category-weak { background: #ffeaa7; color: #d63031; }
        .category-pleasant { background: #74b9ff; color: #0984e3; }
        .category-hero { background: #a29bfe; color: #6c5ce7; }
        .category-epic { background: #fd79a8; color: #e84393; }
        
        .axis-label {
            font-size: 12px;
            fill: #495057;
        }
        
        .grid-line {
            stroke: #e9ecef;
            stroke-width: 1;
            stroke-dasharray: 2,2;
        }
        
        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚òÅÔ∏è SkyMatch</h1>
            <div class="subtitle">Find similar flying days from historical data</div>
        </header>
        
        <div class="controls">
            <div class="date-selector">
                <label for="dateSelect">Select a day to analyze:</label>
                <select id="dateSelect">
                    <option value="">Loading dates...</option>
                </select>
                <button id="forecastBtn" class="forecast-btn">üì° Today's Forecast</button>
            </div>
            
            <div id="matchButtons" class="match-buttons">
                <!-- Match buttons will be populated here -->
            </div>
        </div>
        
        <div class="content">
            <div class="main-content">
                <div class="skewt-container">
                    <div class="loading" id="skewt-loading">
                        Select a date above to see the comparison
                    </div>
                    <img id="skewt-image" style="display:none;" />
                </div>
                
                <div class="scatter-container">
                    <div class="scatter-title">Historical Flights - Day Categories</div>
                    <svg id="scatter-plot" width="100%" height="400"></svg>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="info-panel">
                    <h3>Match Information</h3>
                    <div id="info-content">
                        <p style="color: #6c757d; font-style: italic;">Select a match to see details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentMatches = [];
        let currentTarget = null;
        let scatterData = [];
        let isForecastMode = false;
        
        // Load available dates
        fetch('/api/dates')
            .then(r => r.json())
            .then(dates => {
                const select = document.getElementById('dateSelect');
                select.innerHTML = '<option value="">Choose a date...</option>';
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    select.appendChild(option);
                });
            });
        
        // Load scatter plot data
        fetch('/api/scatter_data')
            .then(r => r.json())
            .then(data => {
                scatterData = data;
                drawScatterPlot();
            });
        
        // Handle date selection
        document.getElementById('dateSelect').addEventListener('change', function(e) {
            const date = e.target.value;
            if (!date) return;
            
            isForecastMode = false;
            currentTarget = date;
            loadMatches(date);
        });
        
        // Handle forecast button
        document.getElementById('forecastBtn').addEventListener('click', function() {
            isForecastMode = true;
            currentTarget = 'forecast';
            
            const loading = document.getElementById('skewt-loading');
            const img = document.getElementById('skewt-image');
            
            loading.textContent = 'Fetching current forecast from NOAA...';
            loading.style.display = 'block';
            img.style.display = 'none';
            
            document.getElementById('dateSelect').value = '';
            
            // Fetch forecast and get matches
            fetch('/api/fetch_forecast')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        return fetch('/api/forecast_matches');
                    } else {
                        throw new Error(data.error || 'Failed to fetch forecast');
                    }
                })
                .then(r => r.json())
                .then(matches => {
                    currentMatches = matches;
                    renderMatchButtons();
                    if (matches.length > 0) {
                        selectMatch(0);
                    }
                })
                .catch(err => {
                    loading.textContent = 'Error: ' + err.message;
                    console.error('Forecast error:', err);
                });
        });
        
        function loadMatches(date) {
            fetch(`/api/matches/${date}`)
                .then(r => r.json())
                .then(matches => {
                    currentMatches = matches;
                    renderMatchButtons();
                    if (matches.length > 0) {
                        selectMatch(0);
                    }
                });
        }
        
        function renderMatchButtons() {
            const container = document.getElementById('matchButtons');
            container.innerHTML = '';
            
            currentMatches.forEach((match, idx) => {
                const btn = document.createElement('button');
                btn.className = 'match-btn' + (idx === 0 ? ' active' : '');
                btn.innerHTML = `
                    Match ${idx + 1}
                    <span class="score">Score: ${match.score.toFixed(1)}</span>
                `;
                btn.onclick = () => selectMatch(idx);
                container.appendChild(btn);
            });
        }
        
        function selectMatch(idx) {
            // Update button states
            document.querySelectorAll('.match-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === idx);
            });
            
            const match = currentMatches[idx];
            
            // Load comparison image
            const loading = document.getElementById('skewt-loading');
            const img = document.getElementById('skewt-image');
            
            loading.textContent = 'Generating comparison...';
            loading.style.display = 'block';
            img.style.display = 'none';
            
            fetch(`/api/comparison/${currentTarget}/${match.date}`)
                .then(r => r.json())
                .then(data => {
                    img.src = 'data:image/png;base64,' + data.image;
                    img.style.display = 'block';
                    loading.style.display = 'none';
                    
                    updateScatterPlot(match.date);
                });
            
            // Update info panel
            updateInfoPanel(match);
        }
        
        function updateInfoPanel(match) {
            const category = categorizeDay(match.num_pilots, match.max_distance);
            const info = document.getElementById('info-content');
            
            const targetInfo = isForecastMode ? 
                `<div class="info-row">
                    <span class="info-label">Mode:</span>
                    <span class="info-value" style="color: #667eea; font-weight: 600;">Today's Forecast</span>
                </div>` :
                `<div class="info-row">
                    <span class="info-label">Target Date:</span>
                    <span class="info-value">${currentTarget}</span>
                </div>`;
            
            info.innerHTML = targetInfo + `
                <div class="info-row">
                    <span class="info-label">Best Match:</span>
                    <span class="info-value">${match.date}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Similarity Score:</span>
                    <span class="info-value">${match.score.toFixed(1)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Pilots (that day):</span>
                    <span class="info-value">${match.num_pilots}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Longest Flight:</span>
                    <span class="info-value">${match.max_distance.toFixed(1)} km</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Day Type:</span>
                    <span class="info-value">
                        <span class="category-badge category-${category.class}">${category.name}</span>
                    </span>
                </div>
            `;
        }
        
        function categorizeDay(pilots, distance) {
            if (pilots < 5) {
                if (distance < 50) return {name: 'Weak', class: 'weak'};
                return {name: 'Hero', class: 'hero'};
            } else {
                if (distance < 50) return {name: 'Pleasant', class: 'pleasant'};
                return {name: 'Epic', class: 'epic'};
            }
        }
        
        function drawScatterPlot() {
            const svg = d3.select('#scatter-plot');
            const containerWidth = document.querySelector('.scatter-container').clientWidth - 40;
            const width = containerWidth;
            const height = 400;
            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            
            svg.attr('width', width).attr('height', height);
            svg.selectAll('*').remove();
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;
            
            // Scales
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(scatterData, d => d.max_distance) * 1.1])
                .range([0, plotWidth]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(scatterData, d => d.num_pilots) * 1.1])
                .range([plotHeight, 0]);
            
            // Category zones (background)
            const zones = [
                {x1: 0, y1: 0, x2: 50, y2: 5, color: '#ffeaa7', label: 'Weak Days'},
                {x1: 50, y1: 0, x2: 200, y2: 5, color: '#a29bfe', label: 'Hero Days'},
                {x1: 0, y1: 5, x2: 50, y2: 50, color: '#74b9ff', label: 'Pleasant Days'},
                {x1: 50, y1: 5, x2: 200, y2: 50, color: '#fd79a8', label: 'Epic Days'}
            ];
            
            zones.forEach(zone => {
                g.append('rect')
                    .attr('x', xScale(zone.x1))
                    .attr('y', yScale(zone.y2))
                    .attr('width', xScale(zone.x2) - xScale(zone.x1))
                    .attr('height', yScale(zone.y1) - yScale(zone.y2))
                    .attr('fill', zone.color)
                    .attr('opacity', 0.2);
                
                // Add zone label
                g.append('text')
                    .attr('x', xScale((zone.x1 + zone.x2) / 2))
                    .attr('y', yScale((zone.y1 + zone.y2) / 2))
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '12px')
                    .attr('fill', '#666')
                    .attr('font-weight', 'bold')
                    .text(zone.label);
            });
            
            // Axes
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);
            
            g.append('g')
                .attr('transform', `translate(0,${plotHeight})`)
                .call(xAxis);
            
            g.append('g')
                .call(yAxis);
            
            // Axis labels
            g.append('text')
                .attr('x', plotWidth / 2)
                .attr('y', plotHeight + 45)
                .attr('text-anchor', 'middle')
                .attr('class', 'axis-label')
                .text('Longest Flight Distance (km)');
            
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -plotHeight / 2)
                .attr('y', -45)
                .attr('text-anchor', 'middle')
                .attr('class', 'axis-label')
                .text('Number of Pilots');
            
            // Plot points
            g.selectAll('.dot')
                .data(scatterData)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.max_distance))
                .attr('cy', d => yScale(d.num_pilots))
                .attr('r', 4)
                .attr('fill', '#667eea')
                .attr('opacity', 0.6)
                .attr('data-date', d => d.date);
            
            // Store scales for updates
            svg.xScale = xScale;
            svg.yScale = yScale;
        }
        
        function updateScatterPlot(highlightDate) {
            const svg = d3.select('#scatter-plot');
            const g = svg.select('g');
            
            // Reset all dots
            g.selectAll('.dot')
                .attr('r', 4)
                .attr('fill', '#667eea')
                .attr('opacity', 0.6)
                .attr('stroke', 'none');
            
            // Highlight selected
            g.selectAll('.dot')
                .filter(d => d.date === highlightDate)
                .attr('r', 8)
                .attr('fill', '#e84393')
                .attr('opacity', 1)
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
        }
        
        // Responsive resize
        window.addEventListener('resize', () => {
            if (scatterData.length > 0) {
                drawScatterPlot();
            }
        });
    </script>
</body>
</html>
